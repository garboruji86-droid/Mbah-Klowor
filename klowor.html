<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MbahKlowor Voice Over AI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #070709;
            color: white;
            -webkit-font-smoothing: antialiased;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius: 10px; }
        
        input[type='range'] {
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.05);
            border-radius: 999px;
        }
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #f97316;
            border: 3px solid #0f0f13;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(249,115,22,0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        /**
         * Komponen Ikon yang diperbaiki
         * Menggunakan lucide.createIcons untuk keamanan kompatibilitas
         */
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    // Konversi CamelCase ke kebab-case untuk data-lucide attribute
                    const lucideName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconRef.current.setAttribute('data-lucide', lucideName);
                    iconRef.current.setAttribute('width', size);
                    iconRef.current.setAttribute('height', size);
                    
                    window.lucide.createIcons({
                        attrs: {
                            class: className,
                            'stroke-width': 2
                        }
                    });
                }
            }, [name, size, className]);

            return <i ref={iconRef} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const App = () => {
            const [text, setText] = useState('');
            const [language, setLanguage] = useState('id-ID');
            const [dialect, setDialect] = useState('Standar');
            const [gender, setGender] = useState('Pria');
            const [style, setStyle] = useState('santai');
            const [emotion, setEmotion] = useState('normal');
            const [speed, setSpeed] = useState(1.0);
            const [isGenerating, setIsGenerating] = useState(false);
            const [audioUrl, setAudioUrl] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [errorMessage, setErrorMessage] = useState(null);
            const audioRef = useRef(null);

            const apiKey = "AIzaSyC8fG02j4uZUqwagaI2VI99IxTmpnudQyM"; 

            const voices = {
                Pria: ["Zephyr", "Puck", "Charon", "Fenrir", "Orus"],
                Wanita: ["Kore", "Leda", "Aoede", "Callirrhoe", "Autonoe"]
            };

            const dialects = {
                'id-ID': ['Standar', 'Logat Jawa', 'Logat Sunda'],
                'en-US': ['Inggris US', 'Inggris British', 'Inggris Australia', 'Inggris India']
            };

            const styles = ['santai', 'cerita', 'dramatis', 'formal', 'reflektif', 'inspiratif'];
            const emotions = ['normal', 'tertawa', 'menangis', 'berbisik', 'sedih', 'ceria'];

            const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (retries > 0 && (response.status === 429 || response.status >= 500)) {
                            await new Promise(resolve => setTimeout(resolve, backoff));
                            return fetchWithRetry(url, options, retries - 1, backoff * 2);
                        }
                        throw new Error(`API Error: ${response.status}`);
                    }
                    return response;
                } catch (err) {
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, backoff));
                        return fetchWithRetry(url, options, retries - 1, backoff * 2);
                    }
                    throw err;
                }
            };

            const createAudioBlob = (pcmData, sampleRate = 24000) => {
                const buffer = new ArrayBuffer(44 + pcmData.length * 2);
                const view = new DataView(buffer);
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + pcmData.length * 2, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, pcmData.length * 2, true);
                let offset = 44;
                for (let i = 0; i < pcmData.length; i++, offset += 2) {
                    view.setInt16(offset, pcmData[i], true);
                }
                return new Blob([buffer], { type: 'audio/wav' });
            };

            const handleGenerate = async () => {
                if (!text) return;
                setIsGenerating(true);
                setAudioUrl(null);
                setErrorMessage(null);
                try {
                    const voiceList = voices[gender];
                    const voiceName = voiceList[Math.floor(Math.random() * voiceList.length)];
                    const langName = language === 'id-ID' ? 'Indonesia' : 'Inggris';
                    const dialectText = dialect !== 'Standar' ? ` dengan ${dialect}` : '';
                    const emotionText = emotion !== 'normal' ? ` dengan nada ${emotion}` : '';
                    const systemInstruction = `Bicaralah sebagai pengisi suara ${gender} dalam bahasa ${langName}. Gaya ${style}${dialectText}${emotionText}.`;
                    
                    const response = await fetchWithRetry(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, 
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `${systemInstruction} Narasi: ${text}` }] }],
                                generationConfig: {
                                    responseModalities: ["AUDIO"],
                                    speechConfig: {
                                        voiceConfig: {
                                            prebuiltVoiceConfig: { voiceName: voiceName }
                                        }
                                    }
                                }
                            })
                        }
                    );
                    const result = await response.json();
                    const base64Audio = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (!base64Audio) throw new Error("Gagal mengambil audio.");
                    const binaryString = atob(base64Audio);
                    const pcmData = new Int16Array(binaryString.length / 2);
                    for (let i = 0; i < pcmData.length; i++) {
                        pcmData[i] = binaryString.charCodeAt(i * 2) | (binaryString.charCodeAt(i * 2 + 1) << 8);
                    }
                    const audioBlob = createAudioBlob(pcmData);
                    const url = URL.createObjectURL(audioBlob);
                    setAudioUrl(url);
                } catch (error) {
                    setErrorMessage("Gagal memproses suara. Coba lagi.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const togglePlay = () => {
                if (!audioRef.current) return;
                if (isPlaying) { audioRef.current.pause(); } 
                else { 
                    audioRef.current.playbackRate = speed;
                    audioRef.current.play(); 
                }
                setIsPlaying(!isPlaying);
            };

            const downloadAudio = () => {
                if (!audioUrl) return;
                const link = document.createElement('a');
                link.href = audioUrl;
                link.download = `MbahKlowor_Voice_${Date.now()}.wav`;
                link.click();
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        {/* Header */}
                        <header className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
                            <div className="flex items-center gap-5">
                                <div className="w-14 h-14 bg-orange-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-orange-500/30">
                                    <Icon name="Mic2" size={28} className="text-white" />
                                </div>
                                <div>
                                    <h1 className="text-3xl font-black uppercase leading-none">
                                        <span className="text-orange-500">Mbah</span>
                                        <span className="text-white">Klowor</span>
                                    </h1>
                                    <p className="text-[10px] font-bold text-white/60 uppercase tracking-[0.3em] mt-1 italic">Voice Over Studio</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3 px-5 py-2.5 bg-white/5 rounded-full border border-white/10 backdrop-blur-md">
                                <div className="w-2.5 h-2.5 rounded-full bg-orange-500 animate-pulse shadow-[0_0_10px_rgba(249,115,22,0.5)]" />
                                <span className="text-[11px] font-black uppercase text-white tracking-wider">MbahKlowor Engine Online</span>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-10">
                            {/* Editor Area */}
                            <div className="lg:col-span-8 space-y-8">
                                <div className="relative bg-[#0f0f13] border border-white/10 rounded-[3rem] p-8 md:p-10 shadow-2xl overflow-hidden group">
                                    <textarea 
                                        className="w-full h-72 bg-transparent border-none focus:ring-0 text-xl md:text-2xl leading-relaxed placeholder:text-white/10 resize-none z-10 relative text-white"
                                        placeholder="Ketik narasi MbahKlowor di sini..."
                                        value={text}
                                        onChange={(e) => setText(e.target.value)}
                                        maxLength={1000}
                                    />
                                    <div className="flex flex-wrap justify-between items-center mt-6 border-t border-white/10 pt-8 z-10 relative gap-4">
                                        <span className="text-[10px] font-black text-white/40 uppercase tracking-widest">{text.length} / 1000</span>
                                        <div className="flex items-center gap-4">
                                            {errorMessage && (
                                                <div className="text-red-400 text-[10px] font-black uppercase flex items-center gap-2">
                                                    <Icon name="AlertCircle" size={14} /> {errorMessage}
                                                </div>
                                            )}
                                            <button 
                                                onClick={handleGenerate}
                                                disabled={isGenerating || !text}
                                                className="px-10 py-5 bg-orange-600 hover:bg-orange-500 disabled:opacity-20 text-white rounded-[1.5rem] font-black text-xs uppercase tracking-[0.2em] transition-all flex items-center gap-3 shadow-2xl shadow-orange-600/40 active:scale-95"
                                            >
                                                {isGenerating ? <Icon name="Loader2" className="animate-spin" /> : <Icon name="Wand2" />}
                                                Generate Voice
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {audioUrl && (
                                    <div className="bg-gradient-to-br from-orange-900/10 to-transparent border border-orange-500/20 rounded-[3rem] p-10 animate-in fade-in slide-in-from-bottom-6 duration-700">
                                        <div className="flex flex-col md:flex-row items-center gap-10">
                                            <button onClick={togglePlay} className="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center shadow-xl hover:scale-105 active:scale-90 transition-all">
                                                {isPlaying ? <Icon name="Pause" size={32} /> : <Icon name="Play" size={32} className="ml-1" />}
                                            </button>
                                            <div className="flex-1 w-full space-y-6">
                                                <div className="flex justify-between items-end">
                                                    <div className="space-y-1">
                                                        <div className="flex items-center gap-3 text-orange-500">
                                                            <Icon name="Waves" size={20} />
                                                            <span className="text-xs font-black uppercase tracking-[0.2em]">Output Ready</span>
                                                        </div>
                                                        <p className="text-[10px] font-bold text-white/50 uppercase italic">WAV Format &bull; Studio Quality</p>
                                                    </div>
                                                    <button onClick={downloadAudio} className="bg-white/5 hover:bg-white/10 text-white px-6 py-3 rounded-2xl border border-white/20 transition-all flex items-center gap-3">
                                                        <Icon name="Download" size={18} className="text-orange-500" />
                                                        <span className="text-[11px] font-black uppercase tracking-widest">Unduh WAV</span>
                                                    </button>
                                                </div>
                                                <div className="h-2.5 bg-white/5 rounded-full overflow-hidden relative">
                                                    <div className={`h-full bg-orange-600 ${isPlaying ? 'w-full transition-all duration-[15s] linear' : 'w-0'}`} />
                                                </div>
                                                <audio ref={audioRef} src={audioUrl} onEnded={() => setIsPlaying(false)} hidden />
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Sidebar Area */}
                            <div className="lg:col-span-4 space-y-8">
                                <div className="bg-[#0f0f13] border border-white/10 rounded-[2.5rem] p-8 space-y-8">
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-3 text-white/60">
                                            <Icon name="Languages" className="text-orange-500" />
                                            <span className="text-[11px] font-black uppercase tracking-[0.2em]">Bahasa</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => {setLanguage('id-ID'); setDialect('Standar');}} className={`py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all border ${language === 'id-ID' ? 'bg-orange-600 border-orange-500 text-white shadow-lg' : 'bg-white/5 border-white/10 text-white/40'}`}>Indonesia</button>
                                            <button onClick={() => {setLanguage('en-US'); setDialect('Inggris US');}} className={`py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all border ${language === 'en-US' ? 'bg-orange-600 border-orange-500 text-white shadow-lg' : 'bg-white/5 border-white/10 text-white/40'}`}>English</button>
                                        </div>
                                        <select value={dialect} onChange={(e) => setDialect(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded-2xl py-4 px-5 text-xs font-black text-white outline-none cursor-pointer">
                                            {dialects[language].map(d => <option key={d} value={d} className="bg-[#0a0a0c]">{d}</option>)}
                                        </select>
                                    </div>

                                    <div className="space-y-4">
                                        <div className="flex items-center gap-3 text-white/60">
                                            <Icon name="Volume2" className="text-orange-500" />
                                            <span className="text-[11px] font-black uppercase tracking-[0.2em]">Karakter</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => setGender('Pria')} className={`py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest border transition-all ${gender === 'Pria' ? 'bg-white text-black border-white' : 'bg-white/5 border-white/10 text-white/40'}`}>Pria</button>
                                            <button onClick={() => setGender('Wanita')} className={`py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest border transition-all ${gender === 'Wanita' ? 'bg-white text-black border-white' : 'bg-white/5 border-white/10 text-white/40'}`}>Wanita</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-[#0f0f13] border border-white/10 rounded-[2.5rem] p-8 space-y-8">
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-3 text-white/60">
                                            <Icon name="Music4" className="text-orange-500" />
                                            <span className="text-[11px] font-black uppercase tracking-[0.2em]">Gaya & Intonasi</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            {styles.map(s => (
                                                <button key={s} onClick={() => setStyle(s)} className={`py-2.5 rounded-xl text-[9px] font-black uppercase border transition-all ${style === s ? 'bg-orange-500/10 border-orange-500 text-orange-500' : 'bg-transparent border-white/10 text-white/20'}`}>{s}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-3 text-white/60">
                                            <Icon name="FastForward" className="text-orange-500" />
                                            <span className="text-[11px] font-black uppercase tracking-[0.2em]">Speed ({speed.toFixed(1)}x)</span>
                                        </div>
                                        <input type="range" min="0.5" max="2.0" step="0.1" value={speed} onChange={(e) => setSpeed(parseFloat(e.target.value))} className="w-full h-2 rounded-full appearance-none cursor-pointer" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <footer className="mt-20 text-center border-t border-white/10 pt-12 pb-16">
                            <p className="text-[10px] font-black text-white/20 uppercase tracking-[0.5em] italic">
                                MbahKlowor Studio &bull; 2026 AI Edition
                            </p>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>